<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RH Calculator System - LocalStorage</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { min-height: 100vh; }
    .main-container { background: #fff; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    .header { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; border-radius: 20px 20px 0 0; padding: 2rem; }
    .stat-card { border-radius: 15px; padding: 1.5rem; text-align: center; color: white; margin-bottom: 1rem; }
    .form-container { background: #f8f9fa; border-radius: 15px; border: 1px solid #dee2e6; }
    .table-container { overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .btn-custom { border-radius: 10px; font-weight: 600; }
    .status-badge { border-radius: 20px; padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="main-container mx-auto p-4" style="max-width: 1400px;">
      
      <!-- Header -->
      <div class="header text-center mb-4">
        <h1><i class="fas fa-store"></i> RH Calculator System</h1>
        <p class="fs-5 mb-0">Return Hari Management - LocalStorage Version</p>
      </div>

      <!-- Statistics -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="stat-card bg-success">
            <h2 id="safe_count">0</h2>
            <p><i class="fas fa-check-circle"></i> Safe Products</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card bg-warning">
            <h2 id="warning_count">0</h2>
            <p><i class="fas fa-exclamation-triangle"></i> For Pull-Out</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card bg-danger">
            <h2 id="expired_count">0</h2>
            <p><i class="fas fa-times-circle"></i> Expired</p>
          </div>
        </div>
      </div>

      <!-- Add Product Form -->
      <div class="form-container p-4 mb-4">
        <h3><i class="fas fa-plus"></i> Add New Product</h3>
        <form id="addForm" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Rack # *</label>
            <input type="text" class="form-control" id="rack" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Product Name *</label>
            <input type="text" class="form-control" id="product_name" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Expiry Date *</label>
            <input type="date" class="form-control" id="expiry_date" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">RH Days *</label>
            <input type="number" class="form-control" id="rh_days" min="1" required>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary btn-custom"><i class="fas fa-plus"></i> Add Product</button>
          </div>
        </form>
      </div>

      <!-- Search & Filter -->
      <div class="row mb-4">
        <div class="col-md-6">
          <input type="text" id="searchBox" class="form-control" placeholder="Search by Rack or Product...">
        </div>
        <div class="col-md-3">
          <select id="statusFilter" class="form-select">
            <option value="">All Products</option>
            <option value="safe">Safe</option>
            <option value="warning">For Pull-Out</option>
            <option value="expired">Expired</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-success w-100" onclick="exportExcel()"><i class="fas fa-download"></i> Export</button>
        </div>
      </div>

      <!-- Products Table -->
      <div class="table-container">
        <div class="table-responsive">
          <table class="table table-hover text-center align-middle">
            <thead class="table-dark">
              <tr>
                <th>Rack #</th>
                <th>Product Name</th>
                <th>Expiry Date</th>
                <th>RH Days</th>
                <th>RH Date</th>
                <th>Days Left</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productTable"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

<script>
let products = JSON.parse(localStorage.getItem("products")) || [];

// --- Add Product ---
// --- Add Product ---
document.getElementById("addForm").addEventListener("submit", function(e){
  e.preventDefault();
  let rack = document.getElementById("rack").value;
  let name = document.getElementById("product_name").value;
  let expiry = document.getElementById("expiry_date").value;
  let rh_days = parseInt(document.getElementById("rh_days").value); // store original only

  let expiryDate = new Date(expiry);
  let rhDate = new Date(expiryDate);
  rhDate.setDate(rhDate.getDate() - (rh_days + 7 - 1)); // apply +7 only here

  let product = {
    id: Date.now(),
    rack,
    product_name: name,
    expiry_date: expiry,
    rh_days, // store original input only
    rh_date: rhDate.toISOString().split("T")[0]
  };

  products.push(product);
  saveData();
  this.reset();
});


// --- Save to LocalStorage ---
function saveData(){
  localStorage.setItem("products", JSON.stringify(products));
  renderTable();
  updateStats();
}

// --- Get Status ---
function getStatus(p){
  let today = new Date().toISOString().split("T")[0];
  if (p.expiry_date <= today) return "expired";
  if (p.rh_date <= today) return "warning";
  return "safe";
}

// --- Days Left ---
function getDaysLeft(expiry){
  let today = new Date();
  let exp = new Date(expiry);
  let diff = Math.ceil((exp - today) / (1000*60*60*24));
  return diff < 0 ? "Expired" : diff+" days";
}

// --- Render Table ---
function renderTable(){
  let search = document.getElementById("searchBox").value.toLowerCase();
  let filter = document.getElementById("statusFilter").value;

  let tbody = document.getElementById("productTable");
  tbody.innerHTML = "";

  products.filter(p => {
    let matches = p.rack.toLowerCase().includes(search) || p.product_name.toLowerCase().includes(search);
    let status = getStatus(p);
    if (filter && status !== filter) return false;
    return matches;
  }).forEach(p => {
    let status = getStatus(p);
    let statusBadge = 
      status === "safe" ? `<span class="badge bg-success">Safe</span>` :
      status === "warning" ? `<span class="badge bg-warning">For Pull-Out</span>` :
      `<span class="badge bg-danger">Expired</span>`;

    let row = `
      <tr>
        <td>${p.rack}</td>
        <td>${p.product_name}</td>
        <td>${p.expiry_date}</td>
        <td>${p.rh_days}</td>
        <td>${p.rh_date}</td>
        <td>${getDaysLeft(p.expiry_date)}</td>
        <td>${statusBadge}</td>
        <td>
          <button class="btn btn-sm btn-info" onclick='editProduct(${p.id})'><i class="fas fa-edit"></i></button>
          <button class="btn btn-sm btn-danger" onclick='deleteProduct(${p.id})'><i class="fas fa-trash"></i></button>
        </td>
      </tr>`;
    tbody.innerHTML += row;
  });
}

// --- Update Stats ---
function updateStats(){
  let today = new Date().toISOString().split("T")[0];
  let safe = products.filter(p => getStatus(p) === "safe").length;
  let warning = products.filter(p => getStatus(p) === "warning").length;
  let expired = products.filter(p => getStatus(p) === "expired").length;

  document.getElementById("safe_count").innerText = safe;
  document.getElementById("warning_count").innerText = warning;
  document.getElementById("expired_count").innerText = expired;
}

// --- Delete Product ---
function deleteProduct(id){
  if(confirm("Are you sure you want to delete this product?")){
    products = products.filter(p => p.id !== id);
    saveData();
  }
}

// --- Edit Product ---
function editProduct(id){
  let p = products.find(p => p.id === id);
  if(!p) return;
  document.getElementById("rack").value = p.rack;
  document.getElementById("product_name").value = p.product_name;
  document.getElementById("expiry_date").value = p.expiry_date;
  document.getElementById("rh_days").value = p.rh_days; // show original only
  deleteProduct(id); // re-add after editing
}


// --- Export Excel ---
function exportExcel(){
  let searchBox = document.getElementById("searchBox");
  let search = searchBox ? searchBox.value.toLowerCase() : "";
  let filter = document.getElementById("statusFilter").value;

  let filtered = products.filter(p => {
    let matches = p.rack.toLowerCase().includes(search) || p.product_name.toLowerCase().includes(search);
    let status = getStatus(p);
    if (filter && status !== filter) return false;
    return matches;
  });

  let data = [["Rack #","Product Name","Expiry Date","RH","RH Date","Days Left","Status"]];
  filtered.forEach(p=>{
    let status = getStatus(p);
    if(status === "warning") status = "Pull-Out";
    if(status === "safe") status = "Safe";
    if(status === "expired") status = "Expired";

    data.push([
      p.rack,
      p.product_name,
      p.expiry_date,
      p.rh_days,
      p.rh_date,
      getDaysLeft(p.expiry_date),
      status
    ]);
  });

  if(data.length === 1){ // only header row
    alert("No products to export with current search/filter.");
    return;
  }

  let ws = XLSX.utils.aoa_to_sheet(data);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Products");
  XLSX.writeFile(wb, "RH_Report_" + new Date().toISOString().split("T")[0] + ".xlsx");
}

// --- Init ---
window.onload = function(){
  renderTable();
  updateStats();

// Make sure search + filter work after reload
  document.getElementById("searchBox").addEventListener("input", renderTable);
  document.getElementById("statusFilter").addEventListener("change", renderTable);
};


</script>
</body>
</html>
